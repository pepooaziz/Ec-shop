<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EC-SHOP - المنتجات</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 20px; direction: rtl; }
    h1 { margin-bottom: 8px }
    .product { border: 1px solid #ddd; padding: 10px; margin-bottom: 8px; border-radius: 4px }
    .price { font-weight: bold; color: #2b8a3e }
    .stock { color: #666 }
  </style>
</head>
<body>
  <header style="display:flex; align-items:center; justify-content:space-between;">
    <div style="display:flex; align-items:center; gap:12px">
      <img src="/assets/logo.svg" alt="EC-SHOP" style="height:56px" />
      <h1 style="margin:0">المنتجات</h1>
    </div>
    <div style="text-align:right">
      <input id="search" placeholder="بحث..." />
    </div>
  </header>
  <div id="status">جاري التحميل…</div>
  <div id="token-area" style="margin:8px 0">
    <label>توكن المصادقة: <input id="auth-token" style="width:320px" placeholder="الصق التوكن هنا" /></label>
    <button id="save-token">حفظ</button>
    <button id="clear-token">مسح</button>
    <span id="token-status" style="margin-left:12px;color:#666"></span>
  </div>
  <div id="login-inline" style="margin:8px 0">
    <button id="open-login">تسجيل دخول (اسم/كلمة)</button>
    <div id="login-inline-box" style="display:none; margin-top:8px; border:1px solid #eee; padding:8px; width:360px">
      <label>اسم المستخدم: <input id="inline-username" value="admin" /></label>
      <label style="margin-left:8px">كلمة المرور: <input id="inline-password" type="password" value="password" /></label>
      <div style="margin-top:8px">
        <button id="inline-login">دخول</button>
        <button id="inline-cancel">إلغاء</button>
      </div>
      <div id="inline-login-msg" style="color:red; margin-top:8px"></div>
    </div>
  </div>
  <div id="list"></div>

  <h2>إضافة / تعديل منتج</h2>
  <form id="product-form">
    <input type="hidden" id="product-id" />
    <div>
      <label>الاسم: <input id="name" required /></label>
    </div>
    <div>
      <label>السعر: <input id="price" type="number" step="0.01" required /></label>
    </div>
    <div>
      <label>المخزون: <input id="stock" type="number" /></label>
    </div>
    <div>
      <label>الصور: <input id="image-file" type="file" accept="image/*" multiple /></label>
    </div>
    <div style="margin-top:8px">
      <button type="submit">حفظ</button>
      <button type="button" id="clear">مسح</button>
    </div>
  </form>

  <script>
    const status = document.getElementById('status');
    const list = document.getElementById('list');
    const form = document.getElementById('product-form');
    const idField = document.getElementById('product-id');
    const nameField = document.getElementById('name');
    const priceField = document.getElementById('price');
    const stockField = document.getElementById('stock');
    const clearBtn = document.getElementById('clear');
    

    async function load(q) {
      try {
        const url = q ? `/products?q=${encodeURIComponent(q)}` : '/products';
        const res = await fetch(url);
        if (!res.ok) throw new Error('Network response was not ok');
        const products = await res.json();
        status.textContent = `عدد المنتجات: ${products.length}`;
        renderList(products);
      } catch (err) {
        status.textContent = 'فشل التحميل: ' + err.message;
      }
    }

    document.getElementById('search').addEventListener('input', (e)=>{
      load(e.target.value);
    });

    function renderList(products) {
      if (!products.length) {
        list.innerHTML = '<p>لا توجد منتجات.</p>';
        return;
      }
      list.innerHTML = products.map(p => `
          <div class="product" data-id="${p.id}">
            <div style="display:flex; gap:12px; align-items:center">
                  ${
                    (p.images && p.images.length)
                      ? `<img src="${p.images[0]}" style="height:64px; object-fit:cover; border-radius:6px" />`
                      : (p.image ? `<img src="${p.image}" style="height:64px; object-fit:cover; border-radius:6px" />` : '<div style="width:64px;height:64px;background:#f5f5f5;border-radius:6px"></div>')
                  }
              <div style="flex:1">
                <div><strong>${p.name}</strong></div>
                <div class="price">السعر: $${p.price}</div>
                <div class="stock">المخزون: ${p.stock ?? 0}</div>
                    ${p.images && p.images.length ? `<div style="margin-top:6px">` + p.images.slice(0,4).map(src=>`<img src="${src}" style="height:32px;width:32px;object-fit:cover;border-radius:4px;margin-left:6px"/>`).join('') + `</div>` : ''}
              </div>
              <div style="margin-top:6px">
                <button data-action="edit">تعديل</button>
                <button data-action="delete">حذف</button>
              </div>
            </div>
          </div>
      `).join('');
      // attach handlers
      list.querySelectorAll('button[data-action="edit"]').forEach(btn => {
        btn.addEventListener('click', onEdit);
      });
      list.querySelectorAll('button[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', onDelete);
      });
    }

    function onEdit(e) {
      const div = e.target.closest('.product');
      const id = div.getAttribute('data-id');
      const name = div.querySelector('strong').textContent;
      const price = div.querySelector('.price').textContent.replace(/[^0-9.]/g, '') || 0;
      const stock = div.querySelector('.stock').textContent.replace(/[^0-9]/g, '') || 0;
      idField.value = id;
      nameField.value = name;
      priceField.value = price;
      stockField.value = stock;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function onDelete(e) {
      if (!confirm('هل تريد حذف هذا المنتج؟')) return;
      const div = e.target.closest('.product');
      const id = div.getAttribute('data-id');
      try {
        const res = await fetch(`/products/${id}`, { method: 'DELETE', headers: getAuthHeaders() });
        if (res.status === 204) {
          load();
        } else {
          const json = await res.json();
          alert('خطأ: ' + (json.error || res.status));
        }
      } catch (err) {
        alert('شبكة: ' + err.message);
      }
    }

    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const id = idField.value;
      const payload = { name: nameField.value, price: Number(priceField.value), stock: Number(stockField.value || 0) };
      // if user selected image files, upload them first
      const fileInput = document.getElementById('image-file');
      if (fileInput && fileInput.files && fileInput.files.length) {
        try {
          const fd = new FormData();
          for (let i=0;i<fileInput.files.length;i++) fd.append('images', fileInput.files[i]);
          const up = await fetch('/upload-images', { method: 'POST', body: fd });
          if (!up.ok) throw new Error('فشل رفع الصور');
          const j = await up.json();
          // server returns { paths: [...] }
          if (j.paths) payload.images = j.paths;
        } catch (err) {
          alert('فشل رفع الصور: ' + err.message);
          return;
        }
      }
      try {
        let res;
        if (id) {
          res = await fetch(`/products/${id}`, { method: 'PUT', headers: getAuthHeaders('application/json'), body: JSON.stringify(payload) });
        } else {
          res = await fetch('/products', { method: 'POST', headers: getAuthHeaders('application/json'), body: JSON.stringify(payload) });
        }
        if (res.ok) {
          clearForm();
          load();
        } else {
          const json = await res.json();
          alert('خطأ: ' + (json.error || res.status));
        }
      } catch (err) {
        alert('شبكة: ' + err.message);
      }
    });

    clearBtn.addEventListener('click', (e) => { e.preventDefault(); clearForm(); });

    // token helpers
    const authInput = document.getElementById('auth-token');
    const saveTokenBtn = document.getElementById('save-token');
    const clearTokenBtn = document.getElementById('clear-token');
    const tokenStatus = document.getElementById('token-status');

    function getAuthHeaders(contentType) {
      const headers = {};
      if (contentType) headers['Content-Type'] = contentType;
      const t = localStorage.getItem('token');
      if (t) headers['Authorization'] = 'Bearer ' + t;
      return headers;
    }

    function refreshTokenUI() {
      const t = localStorage.getItem('token');
      authInput.value = t || '';
      tokenStatus.textContent = t ? 'توكن محفوظ' : 'لم يتم حفظ توكن';
    }

    saveTokenBtn.addEventListener('click', () => { localStorage.setItem('token', authInput.value.trim()); refreshTokenUI(); });
    clearTokenBtn.addEventListener('click', () => { localStorage.removeItem('token'); refreshTokenUI(); });
    refreshTokenUI();

    // Inline login behavior
    const openLoginBtn = document.getElementById('open-login');
    const loginInlineBox = document.getElementById('login-inline-box');
    const inlineLoginBtn = document.getElementById('inline-login');
    const inlineCancelBtn = document.getElementById('inline-cancel');
    const inlineMsg = document.getElementById('inline-login-msg');

    openLoginBtn.addEventListener('click', () => { loginInlineBox.style.display = loginInlineBox.style.display === 'none' ? 'block' : 'none'; inlineMsg.textContent = ''; });
    inlineCancelBtn.addEventListener('click', () => { loginInlineBox.style.display = 'none'; inlineMsg.textContent = ''; });

    inlineLoginBtn.addEventListener('click', async () => {
      inlineMsg.textContent = '';
      const username = document.getElementById('inline-username').value;
      const password = document.getElementById('inline-password').value;
      try {
        const res = await fetch('/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
        if (!res.ok) {
          const j = await res.json().catch(()=>({ error: 'خطأ' }));
          inlineMsg.textContent = j.error || ('خطأ: ' + res.status);
          return;
        }
        const j = await res.json();
        if (j.token) {
          localStorage.setItem('token', j.token);
          refreshTokenUI();
          loginInlineBox.style.display = 'none';
          alert('تم تسجيل الدخول بنجاح');
        } else {
          inlineMsg.textContent = 'لم يتم استلام توكن';
        }
      } catch (err) {
        inlineMsg.textContent = err.message;
      }
    });

    function clearForm() {
      idField.value = '';
      nameField.value = '';
      priceField.value = '';
      stockField.value = '';
    }

    load();
  </script>
</body>
</html>
